<!doctype html>
<html lang="en">
<head>

  <meta charset="utf-8">
  <meta name="description" content="The intersection of development and design." />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  <title>LightBlue Bean to IBM Cloud</title>

  <link rel="icon" type="image/x-icon" href="/img/edit.svg">  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="alternate" type="application/rss+xml" title="Kevin Hoyt" href="/feed.xml" />  

  <link rel="stylesheet" href="/style/kevinhoyt.css" />
  <link rel="stylesheet" href="/style/header.css" />
  <link rel="stylesheet" href="/style/contact.css" />    
  <link rel="stylesheet" href="/style/post.css" />
  <link rel="stylesheet" href="/style/prism.css" />    
  <link rel="stylesheet" href="/style/footer.css" />

</head>
<body>
  
  <header id="header">

  <article>

    <kh-follow>
      <img alt="Kevin Hoyt" src="/img/krhoyt.jpg">
    </kh-follow>

    <nav>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
        <path fill="currentColor" d="M4 18q-.425 0-.712-.288T3 17t.288-.712T4 16h16q.425 0 .713.288T21 17t-.288.713T20 18zm0-5q-.425 0-.712-.288T3 12t.288-.712T4 11h16q.425 0 .713.288T21 12t-.288.713T20 13zm0-5q-.425 0-.712-.288T3 7t.288-.712T4 6h16q.425 0 .713.288T21 7t-.288.713T20 8z"/>
      </svg>         
      <select aria-label="Section">
        <option value="/" >Home</option>
        <option value="/blog" selected>Writing</option>
        <option value="/about" >About</option>
        <option value="/events" >Events</option>
      </select>      
    </nav>

    <ul>
      <li><a aria-label="Home" href="/">Home</a></li>
      <li><a aria-label="Writing (Blog)" href="/blog">Writing</a></li>    
      <li><a aria-label="About" href="/about">About</a></li>
      <li><a aria-label="Events" href="/events">Events</a></li>
    </ul>  

    <div>

      <!-- Bluesky (not listed)
      <a aria-label="Bluesky" href="https://bsky.app/profile/krhoyt.bsky.social" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
          <path fill="currentColor" d="M12 11.388c-.906-1.761-3.372-5.044-5.665-6.662c-2.197-1.55-3.034-1.283-3.583-1.033C2.116 3.978 2 4.955 2 5.528c0 .575.315 4.709.52 5.4c.68 2.28 3.094 3.05 5.32 2.803c-3.26.483-6.157 1.67-2.36 5.898c4.178 4.325 5.726-.927 6.52-3.59c.794 2.663 1.708 7.726 6.444 3.59c3.556-3.59.977-5.415-2.283-5.898c2.225.247 4.64-.523 5.319-2.803c.205-.69.52-4.825.52-5.399c0-.575-.116-1.55-.752-1.838c-.549-.248-1.386-.517-3.583 1.033c-2.293 1.621-4.76 4.904-5.665 6.664"/>
        </svg>
      </a>
      -->

      <!-- Twitter (not listed)
      <a aria-label="Twitter" href="https://x.com/krhoyt" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
          <path fill="currentColor" fill-rule="evenodd" d="M5 1a4 4 0 0 0-4 4v14a4 4 0 0 0 4 4h14a4 4 0 0 0 4-4V5a4 4 0 0 0-4-4zm-.334 3.5a.75.75 0 0 0-.338 1.154l5.614 7.45l-5.915 6.345l-.044.051H6.03l4.83-5.179l3.712 4.928a.75.75 0 0 0 .337.251h4.422a.75.75 0 0 0 .336-1.154l-5.614-7.45L20.017 4.5h-2.05l-4.83 5.18l-3.714-4.928a.75.75 0 0 0-.337-.252zm10.88 13.548L6.431 5.952H8.45l9.114 12.095z" clip-rule="evenodd"/>
        </svg>
      </a>
      -->      

      <!-- GitHub -->
      <a aria-label="GitHub" href="https://github.com/krhoyt" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
          <path fill="currentColor" d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"/>
        </svg>
      </a>      

      <!-- YouTube -->
      <a aria-label="YouTube" href="https://www.youtube.com/channel/UCSFeFhtLBuzU2UMs7oOL54A" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
          <path fill="currentColor" d="m10 15l5.19-3L10 9zm11.56-7.83c.13.47.22 1.1.28 1.9c.07.8.1 1.49.1 2.09L22 12c0 2.19-.16 3.8-.44 4.83c-.25.9-.83 1.48-1.73 1.73c-.47.13-1.33.22-2.65.28c-1.3.07-2.49.1-3.59.1L12 19c-4.19 0-6.8-.16-7.83-.44c-.9-.25-1.48-.83-1.73-1.73c-.13-.47-.22-1.1-.28-1.9c-.07-.8-.1-1.49-.1-2.09L2 12c0-2.19.16-3.8.44-4.83c.25-.9.83-1.48 1.73-1.73c.47-.13 1.33-.22 2.65-.28c1.3-.07 2.49-.1 3.59-.1L12 5c4.19 0 6.8.16 7.83.44c.9.25 1.48.83 1.73 1.73"/>
        </svg>
      </a>          

      <!-- RSS feed -->
      <a aria-label="RSS Feed (XML)" href="/feed.xml" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
          <path fill="currentColor" d="M5 21q-.825 0-1.412-.587T3 19t.588-1.412T5 17t1.413.588T7 19t-.587 1.413T5 21m13.5 0q-.65 0-1.088-.475T16.9 19.4q-.275-2.425-1.312-4.537T12.9 11.1T9.138 8.413T4.6 7.1q-.65-.075-1.125-.512T3 5.5t.45-1.062t1.075-.363q3.075.275 5.763 1.563t4.737 3.337t3.338 4.738t1.562 5.762q.05.625-.363 1.075T18.5 21m-6 0q-.625 0-1.075-.437T10.85 19.5q-.225-1.225-.787-2.262T8.65 15.35t-1.888-1.412T4.5 13.15q-.625-.125-1.062-.575T3 11.5q0-.65.45-1.075t1.075-.325q1.825.25 3.413 1.063t2.837 2.062t2.063 2.838t1.062 3.412q.1.625-.325 1.075T12.5 21"/>
        </svg>
      </a>      

      <!-- Instagram (not listed)
      <a aria-label="Instagram" href="https://www.instagram.com/parkerkrhoyt" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 14 14">
          <path fill="currentColor" fill-rule="evenodd" d="M3.39.787A2.604 2.604 0 0 0 .786 3.39v6.944a2.604 2.604 0 0 0 2.604 2.604h6.944a2.604 2.604 0 0 0 2.603-2.604V3.39A2.604 2.604 0 0 0 10.334.787zm7.693 2.607a.75.75 0 1 1-1.5 0a.75.75 0 0 1 1.5 0m-4.22 1.388a2.08 2.08 0 1 0 0 4.16a2.08 2.08 0 0 0 0-4.16m-3.081 2.08a3.08 3.08 0 1 1 6.16 0a3.08 3.08 0 0 1-6.16 0" clip-rule="evenodd"/>
        </svg>
      </a>
      -->     

    </div>

  </article>

</header>


  
  
    <main>

      <div>

        <img src="/img/covers/beans.jpg" alt="LightBlue Bean to IBM Cloud">

        
          <figcaption>
            <p>Photo by <a href="https://unsplash.com/@m_samson">Monkgogi Samson</a> on <a href="https://unsplash.com/photos/bunch-of-peanut-C0ba0-z1ZoI">Unsplash</a></p>
          </figcaption>
        

      </div>

      <article>

        <h1>LightBlue Bean to IBM Cloud</h1>

        <time>Jan 17, 2019 · 17 min read</time>

        
          <aside>
            
              <p>Web</p>
            
              <p>IoT</p>
            
          </aside>
                
        
        <p>The LightBlue <a href="https://punchthrough.com/bean">Bean</a>, by Punch Through, is one of my favorite IoT development platforms. The Bean has many parts, including an iOS application called the <a href="https://itunes.apple.com/us/app/lightblue-explorer-bluetooth-low-energy/id557428110?mt=8">LightBlue Explorer</a>, that lets you view and control nearby Beans. The gang over at Punch Through recently added the ability for the Explorer application to send Bean data to <a href="https://punchthrough.com/blog/posts/introducing-cloud-connect-for-lightblue-explorer">cloud services</a>. Unfortunately, IBM was not included, so what follows is how to do Bean to IBM Cloud connectivity via iOS.</p>
<div id="keFmb_ZXma0" class="eleventy-plugin-youtube-embed" style="position:relative;width:100%;padding-top: 56.25%;"><iframe style="position:absolute;top:0;right:0;bottom:0;left:0;width:100%;height:100%;" width="100%" height="100%" frameborder="0" title="Embedded YouTube video" src="https://www.youtube-nocookie.com/embed/keFmb_ZXma0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe></div>
<h4>Bean</h4>
<p>The Bean is a <a href="https://en.wikipedia.org/wiki/Bluetooth_Low_Energy">BLE</a> development platform. As such it sports a BLE stack. You program the Bean via an <a href="https://www.arduino.cc/">Arduino</a>-compatible workflow. Various features of the BLE stack are exposed to your Arduino program via an <a href="https://punchthrough.com/bean/reference">API</a>. As the Bean also has an accelerometer, temperature sensor, and RGB LED, the API also exposes those details to your Arduino program.</p>
<pre class="language-c"><code class="language-c"><span class="token comment">// Reporting rate</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> last <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> rate <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>

<span class="token comment">// Setup</span>
<span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Make sure LED is off</span>
  <span class="token comment">// Save battery</span>
  Bean<span class="token punctuation">.</span><span class="token function">setLed</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Deep sleep until needed</span>
  Bean<span class="token punctuation">.</span><span class="token function">enableWakeOnConnect</span><span class="token punctuation">(</span> true <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>As we look at the &quot;setup&quot; function, we can see that there really is not much going on. I use the Bean API to turn off the LED. Then I tell the Bean wake up when a device is connected.</p>
<p>We will be reporting data on a regular basis. I do not want to put the Bean to sleep during that, nor do I want the Arduino to block execution of BLE communication, so I am using the tried and true method of counting ticks from the clock.</p>
<pre class="language-c"><code class="language-c"><span class="token comment">// Loop</span>
<span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token class-name">uint8_t</span> scratch<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Connected to a device</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span> Bean<span class="token punctuation">.</span><span class="token function">getConnectionState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Show connection</span>
    Bean<span class="token punctuation">.</span><span class="token function">setLed</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    
    
    <span class="token comment">// Get clock</span>
    now <span class="token operator">=</span> <span class="token function">millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Check timer</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> now <span class="token operator">-</span> last <span class="token punctuation">)</span> <span class="token operator">>=</span> rate <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Update clock</span>
      last <span class="token operator">=</span> now<span class="token punctuation">;</span>
      
      <span class="token comment">// Set sensor values</span>
      <span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Nobody connected</span>
    <span class="token comment">// Turn off LED</span>
    Bean<span class="token punctuation">.</span><span class="token function">setLed</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    
    
    <span class="token comment">// Deep sleep</span>
    Bean<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span> <span class="token number">0xFFFFFFFF</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>   
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>As the Bean enters the &quot;loop&quot; function, a call to &quot;Bean.getConnectionState()&quot; reveals that no devices are currently connected, so &quot;Bean.sleep( 0xFFFFFFFF )&quot; is called to power down the ATmega until a device connects. The &quot;Bean.sleep()&quot; call takes a number of milliseconds, but if you pass &quot;0xFFFFFFFF&quot; the Bean will sleep indefinitely - in this case, until a device connects.</p>
<p>Once a device, like the iPhone, connects, the Bean springs to life. To show connectivity, I set the on-board RGB LED to green. Next, we start watching ticks from the clock to report sensor data at a one second interval (1000 ms). Then we call an &quot;output()&quot; function to actually report the data.</p>
<pre class="language-c"><code class="language-c"><span class="token comment">// Sensor values on characteristic</span>
<span class="token keyword">void</span> <span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  AccelerationReading acceleration<span class="token punctuation">;</span>
  <span class="token keyword">char</span> content<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token class-name">uint8_t</span> scratch<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">// Read accelerometer</span>
  acceleration <span class="token operator">=</span> Bean<span class="token punctuation">.</span><span class="token function">getAcceleration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Format values as string</span>
  <span class="token function">sprintf</span><span class="token punctuation">(</span>
    content<span class="token punctuation">,</span>
    <span class="token string">"%d,%d,%d,%d"</span><span class="token punctuation">,</span>
    acceleration<span class="token punctuation">.</span>xAxis<span class="token punctuation">,</span>
    acceleration<span class="token punctuation">.</span>yAxis<span class="token punctuation">,</span>
    acceleration<span class="token punctuation">.</span>zAxis<span class="token punctuation">,</span>		
    Bean<span class="token punctuation">.</span><span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Put string into scratch format</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">strlen</span><span class="token punctuation">(</span> content <span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    scratch<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> content<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Set scratch data for various sensors</span>
  Bean<span class="token punctuation">.</span><span class="token function">setScratchData</span><span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span> scratch<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span> content <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>The Bean API exposes &quot;scratch&quot; data areas - also known as characteristic data. You can put a finite amount of data into these areas - 20 whole bytes. In this case, that is enough room. The side effect is that the connected device (iPhone for example) can ask to be notified when scratch data changes.</p>
<p>There are a few different ways to shove four numbers into bytes, but I like &quot;sprintf()&quot; to make a CSV string. That makes it easy to deal when it gets to the device. There are multiple scratch data areas on the Bean, but it all fits in one, so one will do here.</p>
<blockquote>
<p>Architecturally, I suppose putting each of the four values we want to have reported to the connected device, into their own scratch areas would be more sound. But that makes for more code on the device, and as a lazy programmer, why do four times, what you could do once?</p>
</blockquote>
<p>That is all the code for the Bean. From here, we power up the Bean, connect to it using the &quot;<a href="https://punchthrough.com/bean/docs/guides/getting-started/os-x/">Bean Loader</a>&quot; tool, compile the Arduino code, and upload it to the Bean. Once there, the Bean will go to sleep, and wait for a device to connect.</p>
<h4>iOS (Swift 3)</h4>
<p>The semantics of connecting a BLE device to iOS is easily, far and away, the single most popular <a href="http://www.kevinhoyt.com/2016/05/20/the-12-steps-of-bluetooth-swift/">post</a> on my blog. There are a lot of little nuances to BLE, and it does not help that Apple keeps changing the CoreBluetooth interface. I will not repeat all of that information here, just the pertinent bits.</p>
<pre class="language-swift"><code class="language-swift"><span class="token comment">// Data arrived from peripheral</span>
<span class="token keyword">func</span> <span class="token function-definition function">peripheral</span><span class="token punctuation">(</span>
  <span class="token omit keyword">_</span> peripheral<span class="token punctuation">:</span> <span class="token class-name">CBPeripheral</span><span class="token punctuation">,</span> 
  didUpdateValueFor characteristic<span class="token punctuation">:</span> 
  <span class="token class-name">CBCharacteristic</span><span class="token punctuation">,</span> error<span class="token punctuation">:</span> <span class="token class-name">Error</span><span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
  <span class="token comment">// Make sure it is the characteristic we want</span>
  <span class="token keyword">if</span> characteristic<span class="token punctuation">.</span>uuid <span class="token operator">==</span> <span class="token constant">BEAN_SCRATCH_UUID</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get bytes into string</span>
    <span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">(</span>
      data<span class="token punctuation">:</span> characteristic<span class="token punctuation">.</span>value<span class="token operator">!</span><span class="token punctuation">,</span> 
      encoding<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token class-name">Encoding</span><span class="token punctuation">.</span>utf8
    <span class="token punctuation">)</span>
      
    <span class="token comment">// Formalize</span>
    <span class="token keyword">let</span> reading <span class="token operator">=</span> <span class="token class-name">Reading</span><span class="token punctuation">(</span>raw<span class="token punctuation">:</span> content<span class="token operator">!</span><span class="token punctuation">)</span>

    <span class="token comment">// Delegate</span>
    delegate<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">didGet</span><span class="token punctuation">(</span>reading<span class="token punctuation">:</span> reading<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>When the Arduino code on the Bean updates the specified characteristic data (scratch), the iPhone is notified. The data comes across as bytes, which I format back into the CSV string that was sent over. Then I pass the CSV string onto a value object where it is parsed, and various convenience methods are exposed (temperature in fahrenheit or celcius as an example).</p>
<blockquote>
<p>To keep the nightmare of interfaces that need to be implemented for &quot;CBCentralManagerDelegate&quot; and &quot;CBPeripheralDelegate&quot; out of my view controller, I have wrapped all the pertinent BLE bits into a class all their own, with a single, concise delegate method.</p>
</blockquote>
<h4>Cloudant</h4>
<p><a href="http://cloudant.com">Cloudant</a>, <a href="http://couchdb.apache.org/">CouchDB</a> on IBM Cloud, is a document store. It conveniently aligns CRUD operations with HTTP verbs. This means that there is no &quot;driver&quot; or special protocol that your application needs to know. If you are working on a device that supports HTTP, then you can store data in the cloud. iOS speaks HTTP.</p>
<pre class="language-swift"><code class="language-swift"><span class="token keyword">func</span> <span class="token function-definition function">save</span><span class="token punctuation">(</span>reading<span class="token punctuation">:</span><span class="token class-name">Reading</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
  <span class="token comment">// Authentication</span>
  <span class="token keyword">let</span> user_pass <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation"><span class="token keyword">self</span><span class="token punctuation">.</span>key</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">:</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation"><span class="token keyword">self</span><span class="token punctuation">.</span>password</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>using<span class="token punctuation">:</span> <span class="token punctuation">.</span>utf8<span class="token punctuation">)</span>
  <span class="token keyword">let</span> encoded <span class="token operator">=</span> user_pass<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">base64EncodedString</span><span class="token punctuation">(</span>options<span class="token punctuation">:</span> <span class="token class-name">Data</span><span class="token punctuation">.</span><span class="token class-name">Base64EncodingOptions</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>rawValue<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> authorization <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"Basic </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">encoded</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span>

  <span class="token comment">// Build request</span>
  <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token function">URL</span><span class="token punctuation">(</span>string<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"https://</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">account</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">.cloudant.com/</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">database</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span>
  <span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token class-name">URLRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> url<span class="token operator">!</span><span class="token punctuation">)</span>
  request<span class="token punctuation">.</span>httpMethod <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"POST"</span></span>
  request<span class="token punctuation">.</span><span class="token function">addValue</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"application/json"</span></span><span class="token punctuation">,</span> forHTTPHeaderField<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"Content-Type"</span></span><span class="token punctuation">)</span>
  request<span class="token punctuation">.</span><span class="token function">addValue</span><span class="token punctuation">(</span>authorization<span class="token punctuation">,</span> forHTTPHeaderField<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"Authorization"</span></span><span class="token punctuation">)</span>
  request<span class="token punctuation">.</span>httpBody <span class="token operator">=</span> reading<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  <span class="token comment">// Make request</span>
  <span class="token comment">// Handle response</span>
  <span class="token class-name">URLSession</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">dataTask</span><span class="token punctuation">(</span>with<span class="token punctuation">:</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>data<span class="token punctuation">,</span> response<span class="token punctuation">,</span> error<span class="token punctuation">)</span> <span class="token keyword">in</span>
    <span class="token keyword">if</span> error <span class="token operator">!=</span> <span class="token nil constant">nil</span> <span class="token punctuation">{</span>
      <span class="token function">debugPrint</span><span class="token punctuation">(</span>error<span class="token operator">!</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> json <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token class-name">JSONSerialization</span><span class="token punctuation">.</span><span class="token function">jsonObject</span><span class="token punctuation">(</span>with<span class="token punctuation">:</span> data<span class="token operator">!</span><span class="token punctuation">)</span> <span class="token keyword">as</span><span class="token operator">!</span> <span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">:</span><span class="token keyword">Any</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
        <span class="token function">debugPrint</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>Making an HTTP request to Cloudant using Swift take a few steps. The first step is to Base64 encode the username and password pair, and to send them as &quot;Basic Auth&quot;. Creating a document is a POST operation, and we will be sending the document to store as a JSON string. Then we use URLSession to fire off the request. The response is a pretty slender JSON string that includes the &quot;id&quot; of the created document.</p>
<blockquote>
<p>Cloudant has a &quot;Permissions&quot; feature that allows you to generate additional key/token combinations for API access with various rights. Do not send your Cloudant administrator username/password.</p>
</blockquote>
<p>Wait. What? Just an HTTP request to work with the database? Yup! that was easy, right? Perhaps we should go for a bonus round!</p>
<h4>Watson IoT</h4>
<p>Another common endpoint for IoT data on IBM Cloud is <a href="https://www.ibm.com/internet-of-things/platform/watson-iot-platform/">Watson IoT</a>. At its core, Watson IoT is an MQTT broker (MQTT being created, and largely <a href="http://www.eclipse.org/paho/">maintained</a>, by IBM). MQTT is now a nearly de facto standard for IoT devices. This particularly application however, is just publishing data. We do not really need to subscribe to any topics. As it turns out, Watson IoT also supports an HTTP interface to publish device events.</p>
<pre class="language-swift"><code class="language-swift"><span class="token keyword">func</span> <span class="token function-definition function">publish</span><span class="token punctuation">(</span>reading<span class="token punctuation">:</span><span class="token class-name">Reading</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
  <span class="token comment">// Authentication</span>
  <span class="token keyword">let</span> user_pass <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation"><span class="token keyword">self</span><span class="token punctuation">.</span>username</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">:</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation"><span class="token keyword">self</span><span class="token punctuation">.</span>password</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>using<span class="token punctuation">:</span> <span class="token punctuation">.</span>utf8<span class="token punctuation">)</span>
  <span class="token keyword">let</span> encoded <span class="token operator">=</span> user_pass<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">base64EncodedString</span><span class="token punctuation">(</span>options<span class="token punctuation">:</span> <span class="token class-name">Data</span><span class="token punctuation">.</span><span class="token class-name">Base64EncodingOptions</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>rawValue<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> authorization <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"Basic </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">encoded</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span>
    
  <span class="token comment">// Build request</span>
  <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token function">URL</span><span class="token punctuation">(</span>string<span class="token punctuation">:</span>
    <span class="token string-literal"><span class="token string">"https://</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">organization</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">.</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">host</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">:</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">port</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span> <span class="token operator">+</span>
    <span class="token string-literal"><span class="token string">"/api/v0002/application/"</span></span> <span class="token operator">+</span>
    <span class="token string-literal"><span class="token string">"types/</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">device_type</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span> <span class="token operator">+</span>
    <span class="token string-literal"><span class="token string">"/devices/</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">device_id</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span> <span class="token operator">+</span>
    <span class="token string-literal"><span class="token string">"/events/</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">event</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span>
  <span class="token punctuation">)</span>
  <span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token class-name">URLRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> url<span class="token operator">!</span><span class="token punctuation">)</span>
  request<span class="token punctuation">.</span>httpMethod <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"POST"</span></span>
  request<span class="token punctuation">.</span><span class="token function">addValue</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"application/json"</span></span><span class="token punctuation">,</span> forHTTPHeaderField<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"Content-Type"</span></span><span class="token punctuation">)</span>
  request<span class="token punctuation">.</span><span class="token function">addValue</span><span class="token punctuation">(</span>authorization<span class="token punctuation">,</span> forHTTPHeaderField<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"Authorization"</span></span><span class="token punctuation">)</span>
  request<span class="token punctuation">.</span>httpBody <span class="token operator">=</span> reading<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  <span class="token comment">// Make request</span>
  <span class="token comment">// Handle response</span>
  <span class="token class-name">URLSession</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">dataTask</span><span class="token punctuation">(</span>with<span class="token punctuation">:</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>data<span class="token punctuation">,</span> response<span class="token punctuation">,</span> error<span class="token punctuation">)</span> <span class="token keyword">in</span>
    <span class="token keyword">if</span> error <span class="token operator">!=</span> <span class="token nil constant">nil</span> <span class="token punctuation">{</span>
      <span class="token function">debugPrint</span><span class="token punctuation">(</span>error<span class="token operator">!</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>This is almost identical to the Cloudant example, just with a few nuances in terminology.</p>
<ul>
<li>Within Watson IoT, you device categories of devices that will be connecting - this is the &quot;device type&quot;.</li>
<li>Each device in that category gets its own ID (as well as security token) - this is the &quot;device ID&quot;.</li>
<li>A device can trigger an &quot;event&quot; when it has something to report. This can be named whatever you want, and generally incorporated into the MQTT topic string.</li>
<li>The &quot;username&quot; and &quot;password&quot; here are keys generated for applications to access Watson IoT as though they were devices.</li>
</ul>
<p>Knowing the terminology, and where to put them, makes all the difference in using Watson IoT.</p>
<h4>Next Steps</h4>
<p>There are a lot of other services on IBM Cloud that support an HTTP interface, and that could be useful in this scenario. One example that comes to mind, and that is growing in relevance for IoT architectures, is <a href="https://kafka.apache.org/">Kafka</a>. Kafka on IBM Cloud is called &quot;<a href="http://www-03.ibm.com/software/products/en/ibm-message-hub">Message Hub</a>&quot;. I think that would make an interesting next step.</p>
<p>Connecting to Watson IoT over MQTT is possible of course, so I should probably update the application to provide for programmatic channel selection. If you want to see the code in its entirety, or just grab snippets for your own application, check out the <a href="https://github.com/krhoyt/IBM/tree/master/iot/bluetooth/cloud">GitHub repository</a> for this project.</p>

        
      </article>

    </main>

          

  <section id="contact">

  <h2>Let's Build Something Together</h2>

  <p>
    Have a project, collaboration, or opportunity you would like to discuss?
    I am especially interested in work involving web architecture, data,
    IoT, and developer experience.
  </p>

  <form data-netlify="true" netlify-honeypot="bot-field">

    <!-- Honeypot -->
    <div class="field honeypot">
      <label for="pot">Do not fill this out if you are human</label>
      <input id="pot" name="pot" type="text">      
    </div>

    <div class="field">
      <label for="poc">Name</label>
      <input type="text" id="poc" name="name" required>
    </div>

    <div class="field">
      <label for="email">Email</label>
      <input type="email" id="email" name="email" required>
    </div>

    <div class="field">
      <label for="reason">Subject</label>
      <select id="reason" name="reason">
        <option value="">Select an option</option>
        <option value="Feedback">Writing feedback</option>        
        <option value="Project Collaboration">Project collaboration</option>
        <option value="Consulting">Consulting</option>
        <option value="Speaking">Speaking / workshops</option>
        <option value="Career Opportunity">Career opportunity</option>
        <option value="Other">Something else</option>
      </select>
    </div>

    <div class="field">
      <label for="message">Message</label>
      <textarea id="message" name="message" rows="6" required></textarea>
    </div>

    <button aria-label="Send Message" type="button">Send Message</button>    

  </form>

  <p class="email">
    Prefer email? You can reach me at <a aria-label="Email kevin@ketnerlake.com" href="mailto:kevin@ketnerlake.com">kevin@ketnerlake.com</a>.
  </p>

</section>

  <footer id="footer">

  <p>
    Made with ❤️ by Kevin Hoyt &copy; 2025 · Published with <a aria-label="Eleventy" href="https://www.11ty.dev">Eleventy</a>
  </p>
  
</footer>


  <script src="/script/menu.js"></script>

</body>
</html>
